# ALPINE VERSION
FROM alpine:3.18.2

# ENVIRONMENT KAFKA INSTALL
ENV KAFKA_VERSION   3.5.1
ENV SCALA_VERSION   2.13
ENV APP_NAME    kafka
ENV APP_FOLDER  opt
ENV URL_APACHE_KAFKA    https://downloads.apache.org/kafka
ENV KAFKA_HOME  /${APP_FOLDER}/${APP_NAME}_${SCALA_VERSION}-${KAFKA_VERSION}

# INSTALL APPS DEPENDENCIES
RUN apk add --no-cache openjdk11 bash curl libgcc libstdc++ netcat-openbsd

# DOWNLOAD AND INSTALL KAFKA SERVER
RUN curl -o /${APP_FOLDER}/${APP_NAME}_${SCALA_VERSION}-${KAFKA_VERSION}.tgz ${URL_APACHE_KAFKA}/${KAFKA_VERSION}/${APP_NAME}_${SCALA_VERSION}-${KAFKA_VERSION}.tgz
RUN tar -xvf /${APP_FOLDER}/${APP_NAME}_${SCALA_VERSION}-${KAFKA_VERSION}.tgz --directory /${APP_FOLDER}/

# REMOVE .tgz KAFKA SERVER
RUN rm -rf /${APP_FOLDER}/${APP_NAME}_${SCALA_VERSION}-${KAFKA_VERSION}.tgz

# ENTRYPOINT DEFINETION
COPY entrypoint.sh /${APP_FOLDER}/
RUN chmod +x /${APP_FOLDER}/entrypoint.sh

# INIT TOPICS
COPY createtopics.sh /${APP_FOLDER}/
RUN chmod +x /${APP_FOLDER}/createtopics.sh

# CREATE KAFKA USER
RUN adduser -D kafka -s /bin/bash
RUN chown -R kafka:kafka /${APP_FOLDER}/

# CHANGE USER ROOT TO KAFKA
USER kafka
WORKDIR /${APP_FOLDER}/

# ENVIRONMENT COFIG KAFKA SERVER
ENV KAFKA_ZOOKEEPER_HOST  localhost
ENV KAFKA_ZOOKEPER_PORT 2181
ENV KAFKA_ZOOKEEPER_CONNECT ${KAFKA_ZOOKEEPER_HOST}:${KAFKA_ZOOKEPER_PORT}/
ENV KAFKA_ZOOKEPER_MAX_WAIT "80"
ENV KAFKA_PORT "9092"
ENV KAKFA_SERVER 0.0.0.0
ENV KAFKA_MAX_WAIT "80"
ENV KAFKA_TEXT_TOPICS   "input-topic,output-topic"

# EXECUTE ENTRY-POINT
CMD sh /${APP_FOLDER}/entrypoint.sh
#CMD sleep 3600
